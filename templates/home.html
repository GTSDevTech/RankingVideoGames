
{% extends 'base.html' %}

{% load text_filters %}
{% block nav %}
  {% include 'includes/nav.html' %}
{% endblock %}

{% block body_class %}bg-home{% endblock %}

{% block body %}
<main class="home-content">
  <div class="container-fluid min-vh-100 px-5">

    <div class="games-header pt-4 mb-4">
      <div class="games-header__inner">
        <div class="games-header__title">
          <i class="bx bxs-joystick"></i>
          <h2 class="m-0">All Games</h2>
        </div>
        <div class="games-header__sub">Browse the catalogue · Click a card to view details & Rating the game</div>
      </div>
    </div>

    <div class="row g-4 align-items-start home-layout">

      <!-- MAIN GRID -->
      <section class="col-12 col-lg-9">
        <section class="games-grid">
          {% for g in page_obj %}
          <article class="game-card js-tilt js-game-open">
            <div class="game-card__inner">
              <div class="game-card__front">
                <div class="game-cover js-tilt-cover">
                  {% if g.cover_url %}
                    <img src="{{ g.cover_url }}" alt="{{ g.name }}">
                  {% else %}
                    <div class="cover-fallback">{{ g.name }}</div>
                  {% endif %}
                </div>

                <div class="game-body js-tilt-body">
                  <h3 class="game-title js-tilt-title" title="{{ g.name }}">{{ g.name }}</h3>

                  <div class="game-meta js-tilt-meta">
                    {% if g.platforms %}
                      {% for p in g.platforms|split:"|" %}
                        <span class="meta-pill">{{ p }}</span>
                      {% endfor %}
                    {% else %}
                      <span class="meta-pill">Unknown platform</span>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="game-card__back" aria-hidden="true"></div>
      
            <section class="game-hidden" hidden>
              <span data-field="id">{{ g.id }}</span>
              <span data-field="slug">{{ g.slug|default:'' }}</span>
              <span data-field="release">{{ g.first_release_date|default:"" }}</span>
              <span data-field="developers">{{ g.developers|default:'' }}</span>
              <span data-field="publishers">{{ g.publishers|default:'' }}</span>
              <span data-field="rating">{{ g.total_rating|stringformat:"s"|default:"" }}</span>
              <span data-field="rating_count">{{ g.total_rating_count|stringformat:"s"|default:"" }}</span>
              <span data-field="cover">{{ g.cover_url|default:'' }}</span>
              <span data-field="platforms">{{ g.platforms|default:'' }}</span>
              <span data-field="genres">{{ g.genres|default:'' }}</span>
              <span data-field="name">{{ g.name|default:'' }}</span>
            </section>
          </article>
          {% endfor %}
        </section>


    <!-- PAGINATION-->
      <nav class="pagination-wrap" aria-label="Games pagination">
      <ul class="pagination pagination-gamer justify-content-center">

        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link page-link-back" href="?page={{ page_obj.previous_page_number }}">«</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link page-link-back">«</span>
        </li>
        {% endif %}
        {# ventana de páginas: 3 alrededor #}
        {% for num in page_obj.paginator.page_range %}
          {% if num >= page_obj.number|add:"-3" and num <= page_obj.number|add:"3" %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
            {% endif %}
          {% endif %}
        {% endfor %}

       {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link page-link-forward" href="?page={{ page_obj.next_page_number }}">»</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link page-link-forward">»</span>
        </li>
        {% endif %}
        </ul>
        <p class="text-center games-sub m-0">
        Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
      </p>
    </nav>
  </section>
  <aside class="col-12 col-lg-3 right-panel">
    <div class="home-sidebar">

      <!-- Última review (GLOBAL) -->
      <div class="home-panel mb-3" id="sidebarLastReviewPanel">
        <div class="home-panel__head">
          <div>
            <div class="home-panel__title">Última review</div>
            <div class="home-panel__sub">Global (en vivo)</div>
          </div>
          <i class="bx bxs-star"></i>
        </div>

        <div class="home-panel__body">

  
          <div id="sidebarLastReview"></div>


          <div id="sidebarLastReviewEmpty" class="comment-snippet" style="display:none;">
            No hay reviews todavía.
          </div>

          <div id="sidebarLastReviewLoading" class="comment-snippet">
            Cargando…
          </div>

        </div>
      </div>

      <!-- Últimos comentarios (GLOBAL) -->
      <div class="home-panel mb-3" id="sidebarLastCommentsPanel">
        <div class="home-panel__head">
          <div>
            <div class="home-panel__title">Last Comments</div>
            <div class="home-panel__sub">Global (en vivo)</div>
          </div>
          <i class="bx bxs-message-rounded-dots"></i>
        </div>

        <div class="home-panel__body">

          <div id="sidebarLastComments"></div>

          <div id="sidebarLastCommentsEmpty" class="comment-snippet" style="display:none;">
            No hay comentarios todavía.
          </div>

          <div id="sidebarLastCommentsLoading" class="comment-snippet">
            Cargando…
          </div>

        </div>
      </div>

    </div>
  </aside>

</main>

<!-- MODAL  -->
<div class="game-modal" id="gameModal" aria-hidden="true">
  <div class="game-modal__backdrop" data-close></div>

  <div class="game-modal__panel" role="dialog" aria-modal="true" aria-label="Game details">
    <button class="modal-close" type="button" aria-label="Close" data-close>X</button>

    <div class="game-modal__content">

      <!-- LEFT: COVER -->
      <div class="game-modal__cover">
        <img id="modalCover" alt="">
        <div id="modalCoverFallback" class="cover-fallback" style="display:none;">No cover</div>
      </div>

      <!-- CENTER: INFO  -->
      <div class="game-modal__info">
        <h2 id="modalTitle" class="game-modal__title"></h2>

        <div class="game-modal__facts">
          <div class="game-modal__fact"><span>ID:</span> <strong id="modalIgdbId"></strong></div>
          <div class="game-modal__fact"><span>Release:</span> <strong id="modalRelease"></strong></div>
          <div class="game-modal__fact"><span>Rating:</span> <strong id="modalRating"></strong></div>
          <div class="game-modal__fact"><span>Votes:</span> <strong id="modalRatingCount"></strong></div>
          <div class="game-modal__fact"><span>Developers:</span> <strong id="modalDevelopers"></strong></div>
          <div class="game-modal__fact"><span>Publishers:</span> <strong id="modalPublishers"></strong></div>
        </div>

        <div class="game-modal__duo">
          <div class="game-modal__section">
            <h4>Platforms</h4>
            <div id="modalPlatforms" class="game-modal__pills "></div>
          </div>

          <div class="game-modal__section">
            <h4>Genres</h4>
            <div id="modalGenres" class="game-modal__pills"></div>
          </div>
        </div>

        <div class="game-modal__section game-modal__review">
          <h4>Your review</h4>

          <div id="reviewMsg" class="review-msg" style="display:none;"></div>

          <div class="rating-stars" id="ratingStars" aria-label="Your rating">
            <input type="radio" id="rate5" name="user_rating" value="5"><label for="rate5" title="5">★</label>
            <input type="radio" id="rate4" name="user_rating" value="4"><label for="rate4" title="4">★</label>
            <input type="radio" id="rate3" name="user_rating" value="3"><label for="rate3" title="3">★</label>
            <input type="radio" id="rate2" name="user_rating" value="2"><label for="rate2" title="2">★</label>
            <input type="radio" id="rate1" name="user_rating" value="1"><label for="rate1" title="1">★</label>
            <input type="radio" id="rate0" name="user_rating" value="0"><label for="rate0" title="0">✕</label>
          </div>

          <label class="review-label" for="reviewComment">Comment (optional)</label>
          <textarea id="reviewComment" class="review-textarea" rows="3"
                    placeholder="Write a short comment…"></textarea>

          <div class="review-actions">
            <button type="button" class="boss-btn boss-btn--primary" id="btnSaveReview">
              Save review
            </button>
            <button type="button" class="boss-btn boss-btn--ghost" id="btnClearReview">
              Clear
            </button>
          </div>

          <input type="hidden" id="reviewGameId" value="">
        </div>
      </div>
      <!--RIGHT: LAST COMMENTS -->
      <aside class="game-modal__last-comments" aria-label="Latest comments">
        <div class="last-comments__head">
          <h4 class="last-comments__title">Latest comments</h4>

          <!-- contador dinámico -->
          <span class="last-comments__badge" id="lastCommentsCount">0</span>
        </div>

        <div class="last-comments__list" id="lastCommentsList" role="list">
      
          <div class="last-comments__empty" id="lastCommentsEmpty">
            No comments yet.
          </div>
        </div>
      </aside>


    </div>
  </div>
</div>
<script src="/static/js/home-card-game.js"></script>
{% endblock %}
